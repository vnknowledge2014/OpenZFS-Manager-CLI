# Tá»± Ä‘á»™ng yÃªu cáº§u quyá»n Admin
if (!([Security.Principal.WindowsPrincipal][Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole] "Administrator")) {
    Start-Process powershell.exe "-NoProfile -ExecutionPolicy Bypass -File `"$PSCommandPath`"" -Verb RunAs
    Exit
}

function Show-Header {
    Clear-Host
    Write-Host "============================================" -ForegroundColor Cyan
    Write-Host "   ğŸ¦ˆ OPENZFS MANAGER (Windows)" -ForegroundColor Cyan
    Write-Host "============================================" -ForegroundColor Cyan
}

function Check-ZFS {
    if (-not (Get-Command zpool -ErrorAction SilentlyContinue)) {
        Write-Host "âŒ ChÆ°a cÃ i OpenZFS on Windows!" -ForegroundColor Red; Pause; Exit
    }
}

function Scan-Import {
    Write-Host "--- IMPORT POOL ---" -ForegroundColor Yellow
    $out = zpool import 2>&1
    if ($out -match "no pools available") {
        if ((zpool list).Count -gt 1) {
            Write-Host "âœ… CÃ¡c pool Ä‘ang online." -ForegroundColor Green
            zpool list
        } else {
            Write-Host "âš ï¸ KhÃ´ng tÃ¬m tháº¥y pool." -ForegroundColor Red
        }
    } else {
        zpool import -a
        Write-Host "âœ… ÄÃ£ import thÃ nh cÃ´ng." -ForegroundColor Green
    }
    Pause
}

function Eject-Pool {
    zpool list
    $p = Read-Host "Nháº­p tÃªn Pool (hoáº·c 'all')"
    if ($p -eq 'all') { zpool export -a } else { zpool export $p }
    if ($?) { Write-Host "âœ… ÄÃ£ rÃºt an toÃ n." -ForegroundColor Green }
    Pause
}

function Rename-Pool-Fixed {
    Write-Host "--- Äá»”I TÃŠN POOL ---" -ForegroundColor Yellow
    zpool list
    $old = Read-Host "TÃªn cÅ©"
    $new = Read-Host "TÃªn Má»šI"
    
    Write-Host "ğŸ”„ Äang xá»­ lÃ½..." -ForegroundColor Cyan
    zpool export $old
    zpool import $old $new
    
    if ($?) { 
        # Cáº­p nháº­t mountpoint Ä‘á»ƒ Ä‘á»“ng bá»™ metadata
        zfs set mountpoint=/$new $new
        Write-Host "âœ… ÄÃ£ Ä‘á»•i tÃªn thÃ nh cÃ´ng: $new" -ForegroundColor Green 
    } else {
        Write-Host "âŒ Lá»—i khi Ä‘á»•i tÃªn." -ForegroundColor Red
    }
    Pause
}

function Format-Create {
    Write-Host "--- FORMAT & CREATE POOL ---" -ForegroundColor Red
    Get-Disk | Select Number, FriendlyName, Size, PartitionStyle | FT -AutoSize
    $n = Read-Host "Nháº­p Disk Number"
    if (-not $n) { return }
    if ((Read-Host "ğŸ”¥ XÃ“A Sáº CH Disk $n? (y/n)") -ne 'y') { return }

    try {
        Clear-Disk -Number $n -RemoveData -RemoveOEM -Confirm:$false -ErrorAction Stop
        $name = Read-Host "Nháº­p tÃªn Pool má»›i"
        
        Write-Host "ğŸ›  Äang táº¡o Pool..." -ForegroundColor Cyan
        zpool create -f -O compression=lz4 -O normalization=formD -O xattr=sa -O atime=off $name "PHYSICALDRIVE$n"
        
        if ($?) { 
            # Set mountpoint chuáº©n
            zfs set mountpoint=/$name $name
            Write-Host "âœ… Táº¡o thÃ nh cÃ´ng!" -ForegroundColor Green 
        }
    } catch {
        Write-Host "âŒ Lá»—i: $_" -ForegroundColor Red
    }
    Pause
}

function Scrub-Pool {
    Write-Host "--- SCRUB HEALTH CHECK ---" -ForegroundColor Blue
    zpool list
    $p = Read-Host "Nháº­p tÃªn pool check sá»©c khá»e"
    if ($p) {
        zpool scrub $p
        Write-Host "âœ… ÄÃ£ báº¯t Ä‘áº§u tiáº¿n trÃ¬nh Scrub." -ForegroundColor Green
    }
    Pause
}

function Show-Status {
    Write-Host "--- ZPOOL STATUS ---" -ForegroundColor Blue
    zpool status -v
    Pause
}

# --- MAIN LOOP ---
Check-ZFS
do {
    Show-Header
    Write-Host "1. ğŸ”Œ Import Pool"
    Write-Host "2. âï¸  Eject Pool"
    Write-Host "3. ğŸ›   Format & Táº¡o Pool"
    Write-Host "4. ğŸ¥ Scrub Health Check"
    Write-Host "5. ğŸ·  Äá»•i tÃªn Pool"
    Write-Host "6. ğŸ“Š Zpool Status"
    Write-Host "0. âŒ ThoÃ¡t"
    
    $c = Read-Host "Chá»n chá»©c nÄƒng"
    switch ($c) {
        '1' { Scan-Import }
        '2' { Eject-Pool }
        '3' { Format-Create }
        '4' { Scrub-Pool }
        '5' { Rename-Pool-Fixed }
        '6' { Show-Status }
        '0' { Exit }
    }
} while ($true)
