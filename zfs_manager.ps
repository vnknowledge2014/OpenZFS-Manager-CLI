# Tá»± Ä‘á»™ng yÃªu cáº§u quyá»n Admin
if (!([Security.Principal.WindowsPrincipal][Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole] "Administrator")) {
    Start-Process powershell.exe "-NoProfile -ExecutionPolicy Bypass -File `"$PSCommandPath`"" -Verb RunAs
    Exit
}

function Show-Header {
    Clear-Host
    Write-Host "============================================" -ForegroundColor Cyan
    Write-Host "   ğŸ¦ˆ OPENZFS MANAGER (Windows)" -ForegroundColor Cyan
    Write-Host "============================================" -ForegroundColor Cyan
}

function Check-ZFS {
    if (-not (Get-Command zpool -ErrorAction SilentlyContinue)) {
        Write-Host "âŒ ChÆ°a cÃ i OpenZFS on Windows!" -ForegroundColor Red; Pause; Exit
    }
}

function Scan-Import {
    Write-Host "--- IMPORT POOL ---" -ForegroundColor Yellow
    $out = zpool import 2>&1
    if ($out -match "no pools available") {
        if ((zpool list).Count -gt 1) {
            Write-Host "âœ… CÃ¡c pool Ä‘ang online." -ForegroundColor Green
            zpool list
        } else {
            Write-Host "âš ï¸ KhÃ´ng tÃ¬m tháº¥y pool." -ForegroundColor Red
        }
    } else {
        zpool import -a
        Write-Host "âœ… ÄÃ£ import thÃ nh cÃ´ng." -ForegroundColor Green
    }
    Pause
}

function Eject-Pool {
    zpool list
    $p = Read-Host "Nháº­p tÃªn Pool (hoáº·c 'all')"
    if ($p -eq 'all') { zpool export -a } else { zpool export $p }
    if ($?) { Write-Host "âœ… ÄÃ£ rÃºt an toÃ n." -ForegroundColor Green }
    Pause
}

function Rename-Pool-Fixed {
    Write-Host "--- Äá»”I TÃŠN POOL ---" -ForegroundColor Yellow
    zpool list
    $old = Read-Host "TÃªn cÅ©"
    $new = Read-Host "TÃªn Má»šI"
    
    Write-Host "ğŸ”„ Äang xá»­ lÃ½..." -ForegroundColor Cyan
    zpool export $old
    zpool import $old $new
    
    if ($?) { 
        # Cáº­p nháº­t mountpoint Ä‘á»ƒ Ä‘á»“ng bá»™ metadata
        zfs set mountpoint=/$new $new
        Write-Host "âœ… ÄÃ£ Ä‘á»•i tÃªn thÃ nh cÃ´ng: $new" -ForegroundColor Green 
    } else {
        Write-Host "âŒ Lá»—i khi Ä‘á»•i tÃªn." -ForegroundColor Red
    }
    Pause
}

function Format-Create {
    Write-Host "--- FORMAT & CREATE POOL ---" -ForegroundColor Red
    Get-Disk | Select Number, FriendlyName, Size, PartitionStyle | FT -AutoSize
    $n = Read-Host "Nháº­p Disk Number"
    if (-not $n) { return }
    if ((Read-Host "ğŸ”¥ XÃ“A Sáº CH Disk $n? (y/n)") -ne 'y') { return }

    try {
        Clear-Disk -Number $n -RemoveData -RemoveOEM -Confirm:$false -ErrorAction Stop
        $name = Read-Host "Nháº­p tÃªn Pool má»›i"
        
        Write-Host "ğŸ›  Äang táº¡o Pool..." -ForegroundColor Cyan
        zpool create -f -O compression=lz4 -O normalization=formD -O xattr=sa -O atime=off $name "PHYSICALDRIVE$n"
        
        if ($?) { 
            # Set mountpoint chuáº©n
            zfs set mountpoint=/$name $name
            Write-Host "âœ… Táº¡o thÃ nh cÃ´ng!" -ForegroundColor Green 
        }
    } catch {
        Write-Host "âŒ Lá»—i: $_" -ForegroundColor Red
    }
    Pause
}

function Scrub-Pool {
    Write-Host "--- SCRUB HEALTH CHECK ---" -ForegroundColor Blue
    zpool list
    $p = Read-Host "Nháº­p tÃªn pool check sá»©c khá»e"
    if ($p) {
        zpool scrub $p
        Write-Host "âœ… ÄÃ£ báº¯t Ä‘áº§u tiáº¿n trÃ¬nh Scrub." -ForegroundColor Green
    }
    Pause
}


function Snapshot-Manager {
    Write-Host "--- QUáº¢N LÃ SNAPSHOT ---" -ForegroundColor Blue
    Write-Host "1. ğŸ“¸ Táº¡o Snapshot Má»›i"
    Write-Host "2. ğŸ“œ Liá»‡t kÃª Snapshot"
    Write-Host "3. ğŸ”™ Rollback (KhÃ´i phá»¥c)"
    Write-Host "4. ğŸ—‘ï¸  XÃ³a Snapshot"
    Write-Host "0. Quay láº¡i"
    $c = Read-Host "Chá»n"
    switch ($c) {
        '1' { $p = Read-Host "TÃªn Pool/Dataset"; $n = Read-Host "TÃªn Snap"; zfs snapshot "$p@$n"; if($?){Write-Host "âœ… OK" -Fg Green} }
        '2' { zfs list -t snapshot }
        '3' { 
            zfs list -t snapshot
            $s = Read-Host "Nháº­p tÃªn snapshot (VD: pool@snap)"
            if ($s) { zfs rollback -r $s; if($?){Write-Host "âœ… ÄÃ£ rollback!" -Fg Green} }
         }
        '4' { $s = Read-Host "Nháº­p tÃªn snapshot cáº§n xÃ³a"; if($s){zfs destroy $s; Write-Host "âœ… ÄÃ£ xÃ³a" -Fg Green} }
    }
    Pause
}

function Fix-Suspended {
    Write-Host "--- FIX SUSPENDED POOL ---" -ForegroundColor Red
    $sus = zpool list -H -o name,health | Select-String "SUSPENDED"
    if (-not $sus) { Write-Host "âœ… KhÃ´ng cÃ³ pool bá»‹ treo." -Fg Green; Pause; return }
    
    Write-Host "âš ï¸ PHÃT HIá»†N SUSPENDED: $sus" -Fg Yellow
    Write-Host "1. Clear Errors (Thá»­ káº¿t ná»‘i láº¡i)"
    Write-Host "2. Force Export (CÆ°á»¡ng cháº¿ ngáº¯t)"
    $c = Read-Host "Chá»n"
    
    $pname = $sus.ToString().Split("`t")[0]
    if ($c -eq '1') { zpool clear $pname; Write-Host "ÄÃ£ cháº¡y clear." -Fg Cyan }
    if ($c -eq '2') { zpool export -f $pname; Write-Host "ÄÃ£ cháº¡y export -f." -Fg Cyan }
    Pause
}

function Check-Health {
    Write-Host "--- CHECK SSD HEALTH (SMART) ---" -ForegroundColor Blue
    if (-not (Get-Command smartctl -ErrorAction SilentlyContinue)) {
        Write-Host "âŒ ChÆ°a cÃ i smartmontools. HÃ£y cÃ i Ä‘áº·t Ä‘á»ƒ dÃ¹ng tÃ­nh nÄƒng nÃ y." -Fg Red
        Pause; return
    }
    Get-PhysicalDisk | Select FriendlyName, DeviceId, MediaType
    $id = Read-Host "Nháº­p DeviceId (VD: 1, 2...)"
    if ($id) {
        Write-Host "ğŸ” Äang Ä‘á»c SMART..." -Fg Yellow
        smartctl -a "/dev/sd$id" -T permissive | Select-String "Model Family|Device Model|User Capacity|Total_LBAs_Written|Data Units Written|Percentage Used|Media_and_Data_Integrity"
    }
    Pause
}

function Trim-Pool {
    Write-Host "--- SSD TRIM ---" -ForegroundColor Blue
    zpool list
    $p = Read-Host "Nháº­p tÃªn Pool"
    if ($p) {
        Write-Host "1. Cháº¡y TRIM ngay"
        Write-Host "2. Báº­t Auto-TRIM"
        $c = Read-Host "Chá»n"
        if ($c -eq '1') { zpool trim $p; Write-Host "âœ… Äang cháº¡y TRIM ngáº§m." -Fg Green }
        if ($c -eq '2') { zpool set autotrim=on $p; Write-Host "âœ… ÄÃ£ báº­t Auto-TRIM." -Fg Green }
    }
    Pause
}

function Dataset-Manager {
    Write-Host "--- DATASET MANAGER ---" -ForegroundColor Blue
    Write-Host "1. Táº¡o Dataset Má»›i"
    Write-Host "2. Chá»‰nh Compression"
    Write-Host "3. Chá»‰nh Quota"
    $c = Read-Host "Chá»n"
    
    if ($c -eq '1') {
        $n = Read-Host "TÃªn Dataset (VD: tank/Phim)"
        if ($n) { zfs create $n; Write-Host "âœ… ÄÃ£ táº¡o." -Fg Green }
    }
    if ($c -eq '2') {
        $n = Read-Host "TÃªn Dataset"
        $v = Read-Host "Compression (lz4/zstd/off)"
        if ($n -and $v) { zfs set compression=$v $n; Write-Host "âœ… OK" -Fg Green }
    }
    if ($c -eq '3') {
        $n = Read-Host "TÃªn Dataset"
        $v = Read-Host "Quota (VD: 500G)"
        if ($n -and $v) { zfs set quota=$v $n; Write-Host "âœ… OK" -Fg Green }
    }
    Pause
}

function Replication-Manager {
    Write-Host "--- REPLICATION ---" -ForegroundColor Blue
    Write-Host "Clone A -> B"
    $src = Read-Host "Pool Nguá»“n"
    $dst = Read-Host "Pool ÄÃ­ch"
    if ($src -and $dst) {
        $snap = "repl_$(Get-Date -Format FileDateTime)"
        Write-Host "ğŸš€ Äang gá»­i dá»¯ liá»‡u..." -Fg Yellow
        zfs snapshot -r "$src@$snap"
        # PowerShell pipes can be tricky with binary data, using cmd /c for pipe safety
        cmd /c "zfs send -R $src@$snap | zfs receive -F $dst/backup_$src"
        if ($?) {
            Write-Host "âœ… Xong." -Fg Green
            zfs destroy -r "$src@$snap"
        } else {
            Write-Host "âŒ Lá»—i." -Fg Red
        }
    }
    Pause
}

function Migration-Manager {
    Write-Host "--- ğŸšš MIGRATION ASSISTANT (Robocopy) ---" -ForegroundColor Blue
    Write-Host "Copy dá»¯ liá»‡u giá»¯a ZFS vÃ  á»• ngoÃ i (NTFS/ExFAT)." -ForegroundColor Cyan
    Write-Host ""
    Write-Host "1. ğŸ“¥ Import: Non-ZFS -> ZFS (Copy VÃ€O ZFS)"
    Write-Host "2. ğŸ“¤ Export: ZFS -> Non-ZFS (Copy RA KHá»I ZFS)"
    Write-Host "0. Quay láº¡i"
    $direction = Read-Host "Chá»n"
    
    if ($direction -eq '0' -or -not $direction) { return }
    
    if ($direction -eq '1') {
        # IMPORT: Non-ZFS -> ZFS
        $source = Read-Host "Nháº­p Ä‘Æ°á»ng dáº«n NGUá»’N (VD: D:\Data\File.zip)"
        if (-not $source -or -not (Test-Path $source)) {
            Write-Host "âŒ ÄÆ°á»ng dáº«n khÃ´ng tá»“n táº¡i!" -ForegroundColor Red; Pause; return
        }
        
        Write-Host "`nğŸ“‚ CÃ¡c Dataset ZFS hiá»‡n cÃ³:" -ForegroundColor Yellow
        zfs list -o name,mountpoint
        
        $dest = Read-Host "`nNháº­p Ä‘Æ°á»ng dáº«n ZFS ÄÃCH (VD: Z:\tank\Folder)"
    }
    elseif ($direction -eq '2') {
        # EXPORT: ZFS -> Non-ZFS
        Write-Host "`nğŸ“‚ CÃ¡c Dataset ZFS hiá»‡n cÃ³:" -ForegroundColor Yellow
        zfs list -o name,mountpoint
        
        $source = Read-Host "`nNháº­p Ä‘Æ°á»ng dáº«n ZFS NGUá»’N (VD: Z:\tank\Folder\File.zip)"
        if (-not $source -or -not (Test-Path $source)) {
            Write-Host "âŒ ÄÆ°á»ng dáº«n khÃ´ng tá»“n táº¡i!" -ForegroundColor Red; Pause; return
        }
        
        $dest = Read-Host "Nháº­p Ä‘Æ°á»ng dáº«n ÄÃCH Non-ZFS (VD: E:\Backup)"
    }
    else {
        Write-Host "âŒ Lá»±a chá»n khÃ´ng há»£p lá»‡!" -ForegroundColor Red; Pause; return
    }
    
    if (-not $dest) { return }
    
    # Confirm
    Write-Host "`nâš ï¸  Sáº®P COPY:" -ForegroundColor Yellow
    Write-Host "   Tá»«: $source" -ForegroundColor Cyan
    Write-Host "   Äáº¿n: $dest" -ForegroundColor Cyan
    $confirm = Read-Host "Tiáº¿p tá»¥c? (yes/no)"
    if ($confirm -ne 'yes') { Write-Host "ÄÃ£ há»§y." -ForegroundColor Red; Pause; return }
    
    # Execute robocopy
    Write-Host "`nğŸš€ Äang cháº¡y Robocopy..." -ForegroundColor Green
    Write-Host "   Flags: /E /Z /J /MT:16 /R:3 /W:5" -ForegroundColor Gray
    Write-Host ""
    
    robocopy $source $dest /E /Z /J /MT:16 /R:3 /W:5 /NP /ETA
    
    $exitCode = $LASTEXITCODE
    if ($exitCode -lt 8) {
        Write-Host "`nâœ… Copy hoÃ n táº¥t!" -ForegroundColor Green
    } else {
        Write-Host "`nâŒ CÃ³ lá»—i xáº£y ra (Exit code: $exitCode)" -ForegroundColor Red
    }
    Pause
}

function Repair-Manager {
    Write-Host "--- REPAIR DISK ---" -ForegroundColor Red
    zpool status
    $p = Read-Host "TÃªn Pool"
    $old = Read-Host "ID á»” Há»ng (GUID)"
    $new = Read-Host "ID á»” Má»›i (PhysicalDrive...)"
    if ($p -and $old -and $new) {
        zpool replace $p $old $new
        Write-Host "âœ… ÄÃ£ cháº¡y lá»‡nh replace. Kiá»ƒm tra status Ä‘á»ƒ xem resilver." -Fg Green
    }
    Pause
}

function Show-Status {
    Write-Host "--- ZPOOL STATUS ---" -ForegroundColor Blue
    zpool status -v
    Pause
}

# --- MAIN LOOP ---
Check-ZFS
do {
    Show-Header
    Write-Host "1. ğŸ”Œ Import Pool"
    Write-Host "2. âï¸  Eject Pool"
    Write-Host "3. ğŸ›   Format & Táº¡o Pool"
    Write-Host "4. ğŸ¥ Scrub Health Check"
    Write-Host "5. ğŸ·  Äá»•i tÃªn Pool"
    Write-Host "6. ğŸ“Š Zpool Status"
    Write-Host "7. ğŸ“¸ Quáº£n lÃ½ Snapshot"
    Write-Host "8. ğŸš‘ Fix Suspended Pool"
    Write-Host "9. ğŸŒ¡ï¸  Check SSD Health"
    Write-Host "------------------------------"
    Write-Host "10. âš¡ SSD TRIM"
    Write-Host "11. ğŸ—‚ï¸  Dataset Manager"
    Write-Host "12. ğŸš€ Replication"
    Write-Host "13. ğŸ› ï¸  Replace Bad Disk"
    Write-Host "14. ğŸšš Migration (Robocopy)"
    Write-Host "0. âŒ ThoÃ¡t"
    
    $c = Read-Host "Chá»n chá»©c nÄƒng"
    switch ($c) {
        '1' { Scan-Import }
        '2' { Eject-Pool }
        '3' { Format-Create }
        '4' { Scrub-Pool }
        '5' { Rename-Pool-Fixed }
        '6' { Show-Status }
        '7' { Snapshot-Manager }
        '8' { Fix-Suspended }
        '9' { Check-Health }
        '10' { Trim-Pool }
        '11' { Dataset-Manager }
        '12' { Replication-Manager }
        '13' { Repair-Manager }
        '14' { Migration-Manager }
        '0' { Exit }
    }
} while ($true)
